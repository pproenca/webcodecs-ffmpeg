# Build Scripts

Utility scripts for FFmpeg prebuilds repository.

## Commands

| Command | Description |
|---------|-------------|
| `npm run test` | Run tests |
| `npm run check` | Run all checks |
| `npm run check:docs` | Validate documentation |
| `npm run gen` | Generate all (docs + config) |
| `npm run gen:docs` | Generate documentation |
| `npm run gen:config` | Generate build config |
| `npm run versions` | Check for dependency updates (dry-run) |
| `npm run versions:write` | Apply dependency updates |

## Dependency Update Automation

### `fetch-versions.ts`

Checks for new versions of FFmpeg and codec dependencies and updates
`versions.properties`.

**Usage:**

```bash
# Check for updates (dry run)
npm run versions

# Updates versions.properties if new versions are available
npm run versions:write
```

**What it checks:**

| Dependency | Upstream Source |
|------------|----------------|
| FFmpeg | https://github.com/FFmpeg/FFmpeg/releases.atom |
| x264 | https://code.videolan.org/videolan/x264 (stable branch) |
| x265 | https://bitbucket.org/multicoreware/x265_git/tags |
| libvpx | https://github.com/webmproject/libvpx/releases.atom |
| libaom | https://github.com/jbeich/aom/releases.atom |
| SVT-AV1 | https://gitlab.com/AOMediaCodec/SVT-AV1/-/releases.atom |
| dav1d | https://code.videolan.org/videolan/dav1d/-/releases.atom |
| rav1e | https://github.com/xiph/rav1e/releases.atom |
| Theora | https://ftp.osuosl.org/pub/xiph/releases/theora/ |
| Xvid | https://downloads.xvid.com/downloads/ |
| Opus | https://github.com/xiph/opus/releases.atom |
| LAME | 3.100 (stable) |
| Vorbis | https://ftp.osuosl.org/pub/xiph/releases/vorbis/ |
| Ogg | https://ftp.osuosl.org/pub/xiph/releases/ogg/ |
| fdk-aac | https://github.com/mstorsjo/fdk-aac/releases.atom |
| FLAC | https://ftp.osuosl.org/pub/xiph/releases/flac/ |
| Speex | https://ftp.osuosl.org/pub/xiph/releases/speex/ |
| libass | https://github.com/libass/libass/releases.atom |
| FreeType | https://download.savannah.gnu.org/releases/freetype/ |
| NASM | https://github.com/netwide-assembler/nasm/releases.atom |
| OpenSSL | https://github.com/openssl/openssl/releases.atom |

**Stability rules:**

- Only numeric release tags are accepted (no rc/beta/dev suffixes).
- Some dependencies are pinned to known stable versions (e.g., LAME).

**Output:**

```
==========================================
Dependency Version Checker
==========================================

ℹ Checking FFmpeg (current: n8.0)...
✓ FFmpeg: up to date (n8.0)

ℹ Checking x264 (current: stable)...
✓ x264: up to date (stable)

ℹ Checking x265 (current: 4.0)...
⚠ x265: update available: 4.0 → 4.1
✓ x265: updated to 4.1

==========================================
Summary
==========================================
⚠ 1 update(s) available

Updates:
- **x265**: 4.0 → 4.1

ℹ Updated versions.properties
```

### Automated Workflow

GitHub Actions runs this script weekly:

- **Schedule**: Every Monday at 8 AM UTC
- **Trigger**: `.github/workflows/dependency-update-check.yml`
- **Action**: Creates PR if updates available

**Workflow steps:**

1. Fetch latest versions from upstream
2. Compare against `versions.properties`
3. Update `versions.properties` if newer versions found
4. Create pull request with update summary
5. PR includes changelog links and verification steps

**Example PR:**

```markdown
## Dependency Updates Available

This PR was automatically generated by the dependency update checker.

- **FFmpeg**: n8.0 → n8.1
- **x265**: 4.0 → 4.1

### Verification Steps

1. Review changelog links for each updated dependency
2. Check for security advisories or breaking changes
3. Test builds locally:
   ```bash
   ./build/orchestrator.sh darwin-arm64
   ./tests/run-all-tests.sh
   ```
4. Run security scan:
   ```bash
   ./security/scan-artifacts.sh
   ```
5. Verify no regressions in performance benchmarks
```

### Manual Updates

To manually update dependencies:

```bash
# 1. Edit versions.properties
vim versions.properties

# 2. Update version
FFMPEG_VERSION=n8.1

# 3. Test build
./build/orchestrator.sh darwin-arm64

# 4. Run tests
./tests/run-all-tests.sh

# 5. Run security scan
./security/scan-artifacts.sh

# 6. Commit
git add versions.properties
git commit -m "chore(deps): Update FFmpeg to n8.1"
```

## Version Pinning

All dependencies are pinned to specific versions in `versions.properties`:

```properties
# FFmpeg
FFMPEG_VERSION=n8.0

# Video Codecs
X264_VERSION=stable
X265_VERSION=4.0
LIBVPX_VERSION=v1.15.2
LIBAOM_VERSION=v3.12.1

# Audio Codecs
OPUS_VERSION=1.5.2
LAME_VERSION=3.100

# Build Tools
NASM_VERSION=2.16.03

# Network Libraries
OPENSSL_VERSION=3.4.0
```

**Why pin versions?**

- ✅ Reproducible builds
- ✅ Predictable behavior
- ✅ Explicit upgrades (via PR review)
- ✅ Easier debugging (known versions)
- ✅ Security tracking (CVE monitoring)

## Best Practices

### Reviewing Update PRs

When automated PR is created:

1. **Check changelogs**
   - FFmpeg: https://git.ffmpeg.org/gitweb/ffmpeg.git/blob/HEAD:/Changelog
   - x264: https://code.videolan.org/videolan/x264/-/commits/stable
   - x265: https://bitbucket.org/multicoreware/x265_git/src/master/CHANGES

2. **Look for breaking changes**
   - API changes affecting our build flags
   - Deprecated features we use
   - New required dependencies

3. **Check security advisories**
   - FFmpeg: https://www.ffmpeg.org/security.html
   - CVE database: https://cve.mitre.org/
   - GitHub Security: https://github.com/advisories

4. **Test locally before merging**
   ```bash
   gh pr checkout <PR-NUMBER>
   ./build/orchestrator.sh darwin-arm64
   ./tests/run-all-tests.sh
   ```

5. **Run security scan**
   ```bash
   ./security/scan-artifacts.sh
   ```

### Update Frequency

- **Major versions**: Manual review + testing
- **Minor versions**: Automated PR + review
- **Patch versions**: Automated PR + merge
- **Security patches**: Immediate manual update

### Rollback

If update causes issues:

```bash
# Revert versions.properties
git revert <commit-hash>

# Or manually downgrade
vim versions.properties
# Change version back
git commit -am "chore(deps): Rollback <dependency> to <version>"
```

## See Also

- [versions.properties](../versions.properties) - Pinned dependency versions
- [Security Scanning](../security/README.md) - CVE scanning
- [Build System](../BUILD-CONFIG.md) - Codec configuration
