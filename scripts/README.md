# Build Scripts

Utility scripts for FFmpeg prebuilds repository.

## Dependency Update Automation

### `check-dependency-updates.sh`

Automatically checks for new versions of FFmpeg and codec dependencies.

**Usage:**

```bash
# Check for updates (dry run)
./scripts/check-dependency-updates.sh

# Updates versions.properties if new versions available
```

**What it checks:**

| Dependency | Upstream Source |
|------------|----------------|
| FFmpeg | https://github.com/FFmpeg/FFmpeg/tags |
| x264 | https://code.videolan.org/videolan/x264 (stable branch) |
| x265 | https://bitbucket.org/multicoreware/x265_git/tags |
| libvpx | https://github.com/webmproject/libvpx/tags |
| libaom | https://github.com/jbeich/aom/tags |
| SVT-AV1 | https://github.com/AOMediaCodec/SVT-AV1/tags |
| Opus | https://github.com/xiph/opus/tags |
| LAME | 3.100 (stable) |
| fdk-aac | https://github.com/mstorsjo/fdk-aac/tags |
| NASM | https://github.com/netwide-assembler/nasm/tags |
| Yasm | https://github.com/yasm/yasm/tags |
| CMake | https://github.com/Kitware/CMake/tags |

**Output:**

```
==========================================
Dependency Update Checker
==========================================

ℹ Checking FFmpeg (current: n8.0)...
✓ FFmpeg: up to date (n8.0)

ℹ Checking x264 (current: stable)...
✓ x264: up to date (stable)

ℹ Checking x265 (current: 4.0)...
⚠ x265: update available: 4.0 → 4.1
✓ x265: updated to 4.1

==========================================
Summary
==========================================
⚠ 1 update(s) available

Updates:
- **x265**: 4.0 → 4.1

ℹ Updated versions.properties
```

### Automated Workflow

GitHub Actions runs this script weekly:

- **Schedule**: Every Monday at 8 AM UTC
- **Trigger**: `.github/workflows/dependency-update-check.yml`
- **Action**: Creates PR if updates available

**Workflow steps:**

1. Fetch latest versions from upstream
2. Compare against `versions.properties`
3. Update `versions.properties` if newer versions found
4. Create pull request with update summary
5. PR includes changelog links and verification steps

**Example PR:**

```markdown
## Dependency Updates Available

This PR was automatically generated by the dependency update checker.

- **FFmpeg**: n8.0 → n8.1
- **x265**: 4.0 → 4.1

### Verification Steps

1. Review changelog links for each updated dependency
2. Check for security advisories or breaking changes
3. Test builds locally:
   ```bash
   ./build/orchestrator.sh darwin-arm64
   ./tests/run-all-tests.sh
   ```
4. Run security scan:
   ```bash
   ./security/scan-artifacts.sh
   ```
5. Verify no regressions in performance benchmarks
```

### Manual Updates

To manually update dependencies:

```bash
# 1. Edit versions.properties
vim versions.properties

# 2. Update version
FFMPEG_VERSION=n8.1

# 3. Test build
./build/orchestrator.sh darwin-arm64

# 4. Run tests
./tests/run-all-tests.sh

# 5. Run security scan
./security/scan-artifacts.sh

# 6. Commit
git add versions.properties
git commit -m "chore(deps): Update FFmpeg to n8.1"
```

## Version Pinning

All dependencies are pinned to specific versions in `versions.properties`:

```properties
# FFmpeg
FFMPEG_VERSION=n8.0

# Video Codecs
X264_VERSION=stable
X265_VERSION=4.0
VPX_VERSION=v1.14.0
AOM_VERSION=v3.9.1

# Audio Codecs
OPUS_VERSION=v1.5.2
LAME_VERSION=3.100

# Build Tools
NASM_VERSION=2.16.03
CMAKE_VERSION=v3.30.5
```

**Why pin versions?**

- ✅ Reproducible builds
- ✅ Predictable behavior
- ✅ Explicit upgrades (via PR review)
- ✅ Easier debugging (known versions)
- ✅ Security tracking (CVE monitoring)

## Best Practices

### Reviewing Update PRs

When automated PR is created:

1. **Check changelogs**
   - FFmpeg: https://git.ffmpeg.org/gitweb/ffmpeg.git/blob/HEAD:/Changelog
   - x264: https://code.videolan.org/videolan/x264/-/commits/stable
   - x265: https://bitbucket.org/multicoreware/x265_git/src/master/CHANGES

2. **Look for breaking changes**
   - API changes affecting our build flags
   - Deprecated features we use
   - New required dependencies

3. **Check security advisories**
   - FFmpeg: https://www.ffmpeg.org/security.html
   - CVE database: https://cve.mitre.org/
   - GitHub Security: https://github.com/advisories

4. **Test locally before merging**
   ```bash
   gh pr checkout <PR-NUMBER>
   ./build/orchestrator.sh darwin-arm64
   ./tests/run-all-tests.sh
   ```

5. **Run security scan**
   ```bash
   ./security/scan-artifacts.sh
   ```

### Update Frequency

- **Major versions**: Manual review + testing
- **Minor versions**: Automated PR + review
- **Patch versions**: Automated PR + merge
- **Security patches**: Immediate manual update

### Rollback

If update causes issues:

```bash
# Revert versions.properties
git revert <commit-hash>

# Or manually downgrade
vim versions.properties
# Change version back
git commit -am "chore(deps): Rollback <dependency> to <version>"
```

## See Also

- [versions.properties](../versions.properties) - Pinned dependency versions
- [Security Scanning](../security/README.md) - CVE scanning
- [Build System](../BUILD-CONFIG.md) - Codec configuration
