# Design: Add Link Flags Export

## Architecture

### File Generation Strategy

The `link-flags.js` file is generated at artifact population time (not build time) by `populate-artifacts.sh`. This aligns with the existing pattern for `lib/index.js` and `lib/pkgconfig/index.js`.

```
Build Pipeline:
  make package → artifacts/<platform>-<tier>/lib/*.a
                                              ↓
  populate-artifacts.sh → npm/<package>/lib/*.a
                                          lib/index.js
                                          lib/pkgconfig/index.js
                                          link-flags.js  ← NEW
                                          versions.json
```

### Platform-Specific Flags

Link flags vary by platform and are derived from the build system's `FFMPEG_EXTRA_LIBS` plus codec and FFmpeg library dependencies.

#### Darwin (macOS)

```
System libs: -lpthread -lm -lz -lbz2 -liconv -lc++
Frameworks:  -framework VideoToolbox -framework AudioToolbox
             -framework CoreMedia -framework CoreVideo
             -framework CoreFoundation -framework CoreServices
             -framework Security
```

#### Linux (glibc)

```
System libs: -lpthread -lm -lz -lbz2 -ldl -lstdc++
```

#### Linux (musl)

```
System libs: -lpthread -lm -lz -lbz2 -lstdc++
Note: No -ldl (musl has dlopen in libc)
```

### FFmpeg Library Order

Static linking requires libraries in reverse dependency order:

```js
const ffmpeg = [
  '-lavfilter',    // depends on everything below
  '-lpostproc',    // video post-processing
  '-lswscale',     // scaling/conversion
  '-lswresample',  // audio resampling
  '-lavformat',    // container formats
  '-lavdevice',    // device I/O
  '-lavcodec',     // codec implementations
  '-lavutil'       // utilities (base dependency)
];
```

### Codec Dependencies

Based on the build configuration (free tier, LGPL-safe):

```js
const codecs = [
  '-lsvtav1',      // SVT-AV1 encoder
  '-laom',         // AV1 reference codec
  '-ldav1d',       // AV1 decoder
  '-lvpx',         // VP8/VP9
  '-lopus',        // Opus audio
  '-lvorbisenc',   // Vorbis encoder
  '-lvorbis',      // Vorbis decoder
  '-logg',         // Ogg container
  '-lmp3lame'      // MP3 encoder
];
```

For non-free tier, add:
```js
'-lx265',  // HEVC/H.265
'-lx264'   // AVC/H.264
```

### Generated File Format

```js
// link-flags.js - Generated by populate-artifacts.sh
const path = require('path');

const libDir = path.join(__dirname, 'lib');

const ffmpeg = ['-lavfilter', '-lpostproc', '-lswscale', '-lswresample', '-lavformat', '-lavdevice', '-lavcodec', '-lavutil'];
const codecs = ['-lsvtav1', '-laom', '-ldav1d', '-lvpx', '-lopus', '-lvorbisenc', '-lvorbis', '-logg', '-lmp3lame'];
const system = ['-lpthread', '-lm', '-lz', '-lbz2', '-liconv', '-lc++'];
const frameworks = ['-framework VideoToolbox', '-framework AudioToolbox', '-framework CoreMedia', '-framework CoreVideo', '-framework CoreFoundation', '-framework CoreServices', '-framework Security'];

module.exports = {
  libDir,
  flags: [`-L${libDir}`, ...ffmpeg, ...codecs, ...system, ...frameworks].join(' ')
};
```

## Trade-offs

### Generate vs Template

**Chosen: Generate at populate time**
- Pros: Single source of truth in populate-artifacts.sh, consistent with existing index.js generation
- Cons: Slightly more complex shell script

Alternative considered: Commit template files per platform
- Pros: Easier to understand, editable
- Cons: Duplication, risk of drift between build config and link flags

### Single String vs Arrays

**Chosen: Export both libDir and flags string**
- Pros: Simple to consume (`flags` can be passed directly to compiler)
- Cons: Less flexible than structured arrays

The consumer (node-webcodecs) already has platform detection, so a simple string is sufficient.

## Determining Exact Flags

To verify codec dependencies, inspect the FFmpeg build output:

```bash
# From pkg-config files
cat lib/pkgconfig/libavcodec.pc | grep "Libs.private"

# From FFmpeg configure
ffmpeg -buildconf | grep enable
```

The codec list should match what's enabled in `platforms/<platform>/Makefile` under FFmpeg configure options.
