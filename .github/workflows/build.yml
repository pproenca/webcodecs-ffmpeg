name: Build FFmpeg Prebuilds

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      skip_cache:
        description: 'Skip Docker cache (force rebuild)'
        type: boolean
        default: false
  workflow_call:  # Allow this workflow to be reused by other workflows

# Minimal permissions
permissions:
  contents: read

jobs:
  # ==========================================================================
  # Validate - Dry-run codec scripts before expensive builds
  # ==========================================================================
  validate:
    name: Validate codec scripts
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Validate build scripts exist
        run: |
          echo "Validating platform build scripts..."
          for script in \
            platforms/darwin/arm64/build.sh \
            platforms/darwin/x64/build.sh \
            platforms/linux/glibc/x64/build.sh \
            platforms/linux/glibc/arm64/build.sh \
            platforms/linux/glibc/armv7/build.sh \
            platforms/linux/musl/x64/build.sh \
            platforms/linux/musl/arm64/build.sh \
            platforms/windows/x64/build.sh; do
            if [[ -f "$script" ]]; then
              echo "✓ $script"
            else
              echo "✗ $script NOT FOUND"
              exit 1
            fi
          done
          echo "All build scripts validated"

  # ==========================================================================
  # Matrix Build - All Platforms in Parallel
  # ==========================================================================
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.runner }}
    needs: [validate]
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux-x64-glibc
            runner: ubuntu-24.04
            uses_docker: true
            build_script: platforms/linux/glibc/x64/build.sh
          - platform: linux-x64-musl
            runner: ubuntu-24.04
            uses_docker: true
            build_script: platforms/linux/musl/x64/build.sh
          - platform: linux-arm64-glibc
            runner: ubuntu-24.04
            uses_docker: true
            build_script: platforms/linux/glibc/arm64/build.sh
          - platform: linux-arm64-musl
            runner: ubuntu-24.04
            uses_docker: true
            build_script: platforms/linux/musl/arm64/build.sh
          - platform: linux-armv7-glibc
            runner: ubuntu-24.04
            uses_docker: true
            build_script: platforms/linux/glibc/armv7/build.sh
          - platform: windows-x64
            runner: ubuntu-24.04
            uses_docker: true
            build_script: platforms/windows/x64/build.sh
          - platform: darwin-x64
            runner: macos-15-intel
            uses_docker: false
            build_script: platforms/darwin/x64/build.sh
          - platform: darwin-arm64
            runner: macos-15
            uses_docker: false
            build_script: platforms/darwin/arm64/build.sh

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install --ignore-scripts

      # Docker setup for Linux builds
      - name: Set up Docker Buildx
        if: matrix.uses_docker
        uses: docker/setup-buildx-action@v3

      # Install ccache for macOS native builds
      - name: Install ccache (macOS)
        if: ${{ !matrix.uses_docker }}
        run: brew install ccache

      # Cache ccache directory for faster macOS rebuilds
      - name: Setup ccache cache (macOS)
        if: ${{ !matrix.uses_docker }}
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ matrix.platform }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ matrix.platform }}-

      # Configure ccache (macOS)
      - name: Configure ccache (macOS)
        if: ${{ !matrix.uses_docker }}
        run: |
          ccache --set-config=cache_dir=~/.ccache
          ccache --set-config=max_size=2G
          ccache --set-config=compression=true
          ccache -z  # Zero stats for this build

      # Build the platform
      - name: Build ${{ matrix.platform }}
        run: |
          chmod +x ${{ matrix.build_script }}
          ./${{ matrix.build_script }}

      # Show ccache stats after build (macOS)
      - name: Show ccache stats (macOS)
        if: ${{ !matrix.uses_docker }}
        run: |
          echo "=== ccache statistics ==="
          ccache -s

      # Package artifacts
      - name: Package artifacts
        run: |
          cd artifacts
          tar -czf ${{ matrix.platform }}.tar.gz ${{ matrix.platform }}/

      # Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ffmpeg-${{ matrix.platform }}
          path: artifacts/${{ matrix.platform }}.tar.gz
          retention-days: 14
          compression-level: 0  # Already compressed

  # ==========================================================================
  # Create macOS Universal Binary
  # ==========================================================================
  universal:
    name: Create darwin universal
    runs-on: macos-15
    needs: [build]
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      # Download darwin-x64 artifact
      - name: Download darwin-x64
        uses: actions/download-artifact@v7
        with:
          name: ffmpeg-darwin-x64
          path: artifacts-download

      # Download darwin-arm64 artifact
      - name: Download darwin-arm64
        uses: actions/download-artifact@v7
        with:
          name: ffmpeg-darwin-arm64
          path: artifacts-download

      # Extract both architectures
      - name: Extract artifacts
        run: |
          mkdir -p artifacts
          tar -xzf artifacts-download/darwin-x64.tar.gz -C artifacts/
          tar -xzf artifacts-download/darwin-arm64.tar.gz -C artifacts/
          echo "Extracted builds:"
          ls -lh artifacts/

      # Create universal binary
      - name: Create universal binary
        run: |
          chmod +x platforms/darwin/create-universal.sh
          ./platforms/darwin/create-universal.sh

      # Verify universal binary
      - name: Verify universal binary
        run: |
          echo "Verifying ffmpeg:"
          file artifacts/darwin/bin/ffmpeg
          lipo -info artifacts/darwin/bin/ffmpeg

          echo ""
          echo "Verifying ffprobe:"
          file artifacts/darwin/bin/ffprobe
          lipo -info artifacts/darwin/bin/ffprobe

          echo ""
          echo "Testing ffmpeg:"
          artifacts/darwin/bin/ffmpeg -version | head -5

      # Package darwin artifact
      - name: Package darwin artifact
        run: |
          cd artifacts
          tar -czf darwin.tar.gz darwin/

      # Upload darwin artifact
      - name: Upload darwin artifact
        uses: actions/upload-artifact@v6
        with:
          name: ffmpeg-darwin
          path: artifacts/darwin.tar.gz
          retention-days: 14
          compression-level: 0

  # ==========================================================================
  # Package NPM Modules
  # ==========================================================================
  package:
    name: Package npm modules
    runs-on: ubuntu-24.04
    needs: [build, universal]
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install --ignore-scripts

      # Download all platform artifacts
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: ffmpeg-*
          path: artifacts-download

      # Extract all tarballs
      - name: Extract artifacts
        run: |
          mkdir -p artifacts
          for tarball in artifacts-download/ffmpeg-*/*.tar.gz; do
            echo "Extracting $tarball..."
            tar -xzf "$tarball" -C artifacts/
          done
          echo "Extracted artifacts:"
          ls -lh artifacts/

      # Create npm packages
      - name: Create npm packages
        run: npm run package

      # Upload npm packages
      - name: Upload npm packages
        uses: actions/upload-artifact@v6
        with:
          name: npm-packages
          path: npm-dist/
          retention-days: 14

  # ==========================================================================
  # Verification Summary
  # ==========================================================================
  verify:
    name: Build verification summary
    runs-on: ubuntu-24.04
    needs: [package]
    permissions:
      contents: read

    steps:
      - name: Download npm packages
        uses: actions/download-artifact@v7
        with:
          name: npm-packages
          path: npm-dist

      - name: Summary
        run: |
          {
            echo "## Build Summary"
            echo ""
            echo "### NPM Packages Created:"
            echo ""
            echo "\`\`\`"
            find npm-dist -name "package.json" -exec sh -c 'jq -r ".name + \" v\" + .version" "$1"' _ {} \; | sort
            echo "\`\`\`"
            echo ""
            echo "### Package Sizes:"
            echo ""
            echo "\`\`\`"
            du -sh npm-dist/@pproenca/* | sort -h
            echo "\`\`\`"
          } >> "$GITHUB_STEP_SUMMARY"
          {
            echo ""
            echo "✅ All platforms built successfully!"
          } >> "$GITHUB_STEP_SUMMARY"

  # ==========================================================================
  # Security Scanning with Trivy
  # ==========================================================================
  security-scan:
    name: Security vulnerability scan
    runs-on: ubuntu-24.04
    needs: [build]
    permissions:
      contents: read
      security-events: write  # For uploading SARIF results

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      # Download all platform artifacts
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: ffmpeg-*
          path: artifacts-download

      # Extract all tarballs to artifacts/
      - name: Extract artifacts
        run: |
          mkdir -p artifacts
          for tarball in artifacts-download/ffmpeg-*/*.tar.gz; do
            echo "Extracting $tarball..."
            tar -xzf "$tarball" -C artifacts/
          done
          echo "Extracted artifacts:"
          ls -lh artifacts/

      # Install Trivy
      - name: Install Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      # Run security scan
      - name: Run security scan
        run: |
          chmod +x security/scan-artifacts.sh
          ./security/scan-artifacts.sh || true  # Don't fail build on vulnerabilities

      # Upload scan results
      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: security-scan-results
          path: security/results/
          retention-days: 30

      # Generate summary
      - name: Security scan summary
        if: always()
        run: |
          {
            echo "## Security Scan Results"
            echo ""
            if [[ -f security/results/scan-summary.txt ]]; then
              echo "\`\`\`"
              cat security/results/scan-summary.txt
              echo "\`\`\`"
            else
              echo "⚠️ Security scan did not complete"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
