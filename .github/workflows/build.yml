name: Build FFmpeg Prebuilds

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_cache:
        description: 'Skip Docker cache (force rebuild)'
        type: boolean
        default: false

# Minimal permissions
permissions:
  contents: read

jobs:
  # ==========================================================================
  # Matrix Build - All Platforms in Parallel
  # ==========================================================================
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux-x64-glibc
            runner: ubuntu-24.04
            uses_docker: true
          - platform: linux-x64-musl
            runner: ubuntu-24.04
            uses_docker: true
          - platform: linux-arm64-glibc
            runner: ubuntu-24.04
            uses_docker: true
          - platform: linux-arm64-musl
            runner: ubuntu-24.04
            uses_docker: true
          - platform: linux-armv7-glibc
            runner: ubuntu-24.04
            uses_docker: true
          - platform: windows-x64
            runner: ubuntu-24.04
            uses_docker: true
          - platform: darwin-x64
            runner: macos-15-intel
            uses_docker: false
          - platform: darwin-arm64
            runner: macos-15
            uses_docker: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install --ignore-scripts

      # Docker setup for Linux builds
      - name: Set up Docker Buildx
        if: matrix.uses_docker
        uses: docker/setup-buildx-action@v3

      # Load versions into environment
      - name: Load versions from versions.properties
        run: |
          while IFS='=' read -r key value; do
            # Skip comments and empty lines
            [[ "$key" =~ ^#.*$ || -z "$key" ]] && continue
            # Remove leading/trailing whitespace
            key=$(echo "$key" | xargs)
            value=$(echo "$value" | xargs)
            # Export to GitHub environment
            echo "$key=$value" >> "$GITHUB_ENV"
          done < versions.properties

      # Build the platform
      - name: Build ${{ matrix.platform }}
        run: |
          chmod +x build/orchestrator.sh
          ./build/orchestrator.sh ${{ matrix.platform }}
        env:
          # Pass skip_cache flag for Docker builds
          SKIP_CACHE: ${{ inputs.skip_cache || 'false' }}

      # Package artifacts
      - name: Package artifacts
        run: |
          cd artifacts
          tar -czf ${{ matrix.platform }}.tar.gz ${{ matrix.platform }}/

      # Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.platform }}
          path: artifacts/${{ matrix.platform }}.tar.gz
          retention-days: 14
          compression-level: 0  # Already compressed

  # ==========================================================================
  # Create macOS Universal Binary
  # ==========================================================================
  universal:
    name: Create darwin universal
    runs-on: macos-15
    needs: [build]
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Download darwin-x64 artifact
      - name: Download darwin-x64
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-darwin-x64
          path: artifacts-download

      # Download darwin-arm64 artifact
      - name: Download darwin-arm64
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-darwin-arm64
          path: artifacts-download

      # Extract both architectures
      - name: Extract artifacts
        run: |
          mkdir -p artifacts
          tar -xzf artifacts-download/darwin-x64.tar.gz -C artifacts/
          tar -xzf artifacts-download/darwin-arm64.tar.gz -C artifacts/
          echo "Extracted builds:"
          ls -lh artifacts/

      # Create universal binary
      - name: Create universal binary
        run: |
          chmod +x build/create-universal.sh
          ./build/create-universal.sh

      # Verify universal binary
      - name: Verify universal binary
        run: |
          echo "Verifying ffmpeg:"
          file artifacts/darwin/bin/ffmpeg
          lipo -info artifacts/darwin/bin/ffmpeg

          echo ""
          echo "Verifying ffprobe:"
          file artifacts/darwin/bin/ffprobe
          lipo -info artifacts/darwin/bin/ffprobe

          echo ""
          echo "Testing ffmpeg:"
          artifacts/darwin/bin/ffmpeg -version | head -5

      # Package darwin artifact
      - name: Package darwin artifact
        run: |
          cd artifacts
          tar -czf darwin.tar.gz darwin/

      # Upload darwin artifact
      - name: Upload darwin artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-darwin
          path: artifacts/darwin.tar.gz
          retention-days: 14
          compression-level: 0

  # ==========================================================================
  # Package NPM Modules
  # ==========================================================================
  package:
    name: Package npm modules
    runs-on: ubuntu-24.04
    needs: [build, universal]
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install --ignore-scripts

      # Download all platform artifacts
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ffmpeg-*
          path: artifacts-download

      # Extract all tarballs
      - name: Extract artifacts
        run: |
          mkdir -p artifacts
          for tarball in artifacts-download/ffmpeg-*/*.tar.gz; do
            echo "Extracting $tarball..."
            tar -xzf "$tarball" -C artifacts/
          done
          echo "Extracted artifacts:"
          ls -lh artifacts/

      # Create npm packages
      - name: Create npm packages
        run: npm run package

      # Upload npm packages
      - name: Upload npm packages
        uses: actions/upload-artifact@v4
        with:
          name: npm-packages
          path: npm-dist/
          retention-days: 14

  # ==========================================================================
  # Verification Summary
  # ==========================================================================
  verify:
    name: Build verification summary
    runs-on: ubuntu-24.04
    needs: [package]
    permissions:
      contents: read

    steps:
      - name: Download npm packages
        uses: actions/download-artifact@v4
        with:
          name: npm-packages
          path: npm-dist

      - name: Summary
        run: |
          echo "## Build Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### NPM Packages Created:" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
          find npm-dist -name "package.json" -exec sh -c 'jq -r ".name + \" v\" + .version" "$1"' _ {} \; | sort >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Package Sizes:" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
          du -sh npm-dist/@pproenca/* | sort -h >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "✅ All platforms built successfully!" >> "$GITHUB_STEP_SUMMARY"

  # ==========================================================================
  # Security Scanning with Trivy
  # ==========================================================================
  security-scan:
    name: Security vulnerability scan
    runs-on: ubuntu-24.04
    needs: [build]
    permissions:
      contents: read
      security-events: write  # For uploading SARIF results

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Download all platform artifacts
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ffmpeg-*
          path: artifacts-download

      # Extract all tarballs to artifacts/
      - name: Extract artifacts
        run: |
          mkdir -p artifacts
          for tarball in artifacts-download/ffmpeg-*/*.tar.gz; do
            echo "Extracting $tarball..."
            tar -xzf "$tarball" -C artifacts/
          done
          echo "Extracted artifacts:"
          ls -lh artifacts/

      # Install Trivy
      - name: Install Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      # Run security scan
      - name: Run security scan
        run: |
          chmod +x security/scan-artifacts.sh
          ./security/scan-artifacts.sh || true  # Don't fail build on vulnerabilities

      # Upload scan results
      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: security/results/
          retention-days: 30

      # Generate summary
      - name: Security scan summary
        if: always()
        run: |
          echo "## Security Scan Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [[ -f security/results/scan-summary.txt ]]; then
            echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
            cat security/results/scan-summary.txt >> "$GITHUB_STEP_SUMMARY"
            echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "⚠️ Security scan did not complete" >> "$GITHUB_STEP_SUMMARY"
          fi
