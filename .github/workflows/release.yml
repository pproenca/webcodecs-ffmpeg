name: Release

on:
  push:
    tags:
      - 'v*'  # Primary trigger: version tags (e.g., v8.0.0)
  workflow_dispatch:  # Secondary trigger: manual testing
    inputs:
      version:
        description: 'Version to release (e.g., 8.0.1) - without v prefix'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
      npm_tag:
        description: 'NPM tag to use'
        required: false
        type: choice
        default: 'latest'
        options:
          - latest
          - next
          - canary

permissions:
  contents: write
  id-token: write

jobs:
  # ==========================================================================
  # Build all platforms (reuse build workflow)
  # ==========================================================================
  build:
    uses: ./.github/workflows/build.yml
    permissions:
      contents: read

  # ==========================================================================
  # Publish to npm
  # ==========================================================================
  publish:
    name: Publish to npm
    runs-on: ubuntu-24.04
    needs: [build]
    permissions:
      contents: write
      id-token: write

    environment:
      name: npm
      url: https://www.npmjs.com/package/@pproenca/ffmpeg

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Download npm packages
        uses: actions/download-artifact@v7
        with:
          name: npm-packages
          path: npm-dist

      - name: Extract version from tag or input
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual trigger - use input version
            VERSION="${{ inputs.version }}"
            {
              echo "version=$VERSION"
              echo "is_prerelease=${{ inputs.prerelease }}"
              echo "npm_tag=${{ inputs.npm_tag }}"
            } >> "$GITHUB_OUTPUT"
            echo "Manual release: v$VERSION (npm tag: ${{ inputs.npm_tag }})"
          else
            # Tag trigger - extract from tag
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "Publishing version: $VERSION"

            # Detect pre-release (contains -rc, -beta, -alpha)
            if [[ "$VERSION" =~ -(rc|beta|alpha) ]]; then
              {
                echo "version=$VERSION"
                echo "is_prerelease=true"
                echo "npm_tag=next"
              } >> "$GITHUB_OUTPUT"
              echo "This is a pre-release, will use npm tag: next"
            else
              {
                echo "version=$VERSION"
                echo "is_prerelease=false"
                echo "npm_tag=latest"
              } >> "$GITHUB_OUTPUT"
              echo "This is a stable release, will use npm tag: latest"
            fi
          fi

      # Publish platform packages first (main package depends on them)
      - name: Publish platform packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "Publishing platform packages with tag: ${{ steps.version.outputs.npm_tag }}"
          for pkg in npm-dist/@pproenca/ffmpeg-*; do
            PKG_NAME=$(jq -r '.name' "$pkg/package.json")
            echo "Publishing $PKG_NAME..."
            npm publish "$pkg" --access public --provenance --tag ${{ steps.version.outputs.npm_tag }}
          done

      # Wait for npm propagation
      - name: Wait for npm propagation
        run: |
          echo "Waiting 30s for platform packages to propagate..."
          sleep 30

      # Publish main package (depends on platform packages)
      - name: Publish main package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "Publishing main package with tag: ${{ steps.version.outputs.npm_tag }}"
          npm publish npm-dist/@pproenca/ffmpeg --access public --provenance --tag ${{ steps.version.outputs.npm_tag }}

      # Wait for main package propagation
      - name: Wait for main package propagation
        run: |
          echo "Waiting 30s for main package to propagate..."
          sleep 30

      # Smoke test - verify installation works
      - name: Smoke test
        run: |
          mkdir -p /tmp/test-install
          cd /tmp/test-install
          npm init -y
          npm install @pproenca/ffmpeg@${{ steps.version.outputs.version }}

          # Test that binary path resolution works
          node -e "
            const { ffmpegPath, ffprobePath } = require('@pproenca/ffmpeg');
            console.log('FFmpeg path:', ffmpegPath);
            console.log('ffprobe path:', ffprobePath);
            const fs = require('fs');
            if (!fs.existsSync(ffmpegPath)) throw new Error('FFmpeg binary not found');
            if (!fs.existsSync(ffprobePath)) throw new Error('ffprobe binary not found');
            console.log('‚úÖ Smoke test passed!');
          "

  # ==========================================================================
  # Create GitHub Release
  # ==========================================================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-24.04
    needs: [publish]
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download all build artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: ffmpeg-*
          path: artifacts-download

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          cp artifacts-download/ffmpeg-*/*.tar.gz release-assets/

      - name: Load versions
        id: versions
        run: |
          # Load key versions for release notes
          source versions.properties
          {
            echo "ffmpeg=$FFMPEG_VERSION"
            echo "x264=$X264_VERSION"
            echo "x265=$X265_VERSION"
            echo "libvpx=$LIBVPX_VERSION"
            echo "libaom=$LIBAOM_VERSION"
            echo "opus=$OPUS_VERSION"
            echo "lame=$LAME_VERSION"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*.tar.gz
          generate_release_notes: true
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          make_latest: ${{ !(contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha')) }}
          body: |
            ## FFmpeg Prebuilds ${{ github.ref_name }}

            Static FFmpeg binaries and development libraries for Node.js.

            ### üì¶ Installation

            ```bash
            npm install @pproenca/ffmpeg
            ```

            ### üîß Codec Versions

            - **FFmpeg**: `${{ steps.versions.outputs.ffmpeg }}`
            - **x264**: `${{ steps.versions.outputs.x264 }}`
            - **x265**: `${{ steps.versions.outputs.x265 }}`
            - **libvpx**: `${{ steps.versions.outputs.libvpx }}`
            - **libaom (AV1)**: `${{ steps.versions.outputs.libaom }}`
            - **Opus**: `${{ steps.versions.outputs.opus }}`
            - **LAME (MP3)**: `${{ steps.versions.outputs.lame }}`

            ### üñ•Ô∏è Supported Platforms

            **Standard Builds (Software Encoding):**
            - macOS (universal: x64 + ARM64, includes VideoToolbox HW acceleration)
            - Linux x64 (glibc, musl)
            - Linux ARM64 (glibc, musl)
            - Linux ARMv7 (glibc)
            - Windows x64

            **Hardware Acceleration Builds:**
            - Linux x64 VA-API (Intel/AMD GPU)
            - Linux x64 NVENC (NVIDIA GPU)
            - Windows x64 DXVA2 (GPU decode)

            ### üìö Documentation

            - [README.md](https://github.com/pproenca/ffmpeg-prebuilds#readme) - Getting started
            - [HARDWARE.md](https://github.com/pproenca/ffmpeg-prebuilds/blob/master/HARDWARE.md) - Hardware acceleration guide
            - [PERFORMANCE.md](https://github.com/pproenca/ffmpeg-prebuilds/blob/master/PERFORMANCE.md) - Performance optimization
            - [CODECS.md](https://github.com/pproenca/ffmpeg-prebuilds/blob/master/CODECS.md) - Codec details and licensing

            ### üìù License

            GPL-2.0-or-later (due to x264/x265)
