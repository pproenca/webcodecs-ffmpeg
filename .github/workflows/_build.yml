name: Build (Reusable)

on:
  workflow_call:
    inputs:
      ref:
        # Git ref to checkout. Empty string falls back to caller's github.sha
        description: 'Git ref to build'
        type: string
        default: ''
      retention-days:
        description: 'Artifact retention days'
        type: number
        default: 30

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  build:
    name: build-${{ matrix.platform }}-${{ matrix.license }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS platforms (native builds)
          - platform: darwin-arm64
            runner: macos-15
            license: bsd
            arch: arm64
            arch-verify: "arm64"
          - platform: darwin-arm64
            runner: macos-15
            license: lgpl
            arch: arm64
            arch-verify: "arm64"
          - platform: darwin-arm64
            runner: macos-15
            license: gpl
            arch: arm64
            arch-verify: "arm64"
          - platform: darwin-x64
            runner: macos-15-intel
            license: bsd
            arch: x86_64
            arch-verify: "x86_64"
          - platform: darwin-x64
            runner: macos-15-intel
            license: lgpl
            arch: x86_64
            arch-verify: "x86_64"
          - platform: darwin-x64
            runner: macos-15-intel
            license: gpl
            arch: x86_64
            arch-verify: "x86_64"

          # Linux glibc x64 (native builds)
          - platform: linux-x64
            runner: ubuntu-latest
            license: bsd
            arch: x86_64
            arch-verify: "x86-64"
          - platform: linux-x64
            runner: ubuntu-latest
            license: lgpl
            arch: x86_64
            arch-verify: "x86-64"
          - platform: linux-x64
            runner: ubuntu-latest
            license: gpl
            arch: x86_64
            arch-verify: "x86-64"

          # Linux glibc ARM64 (Docker with QEMU)
          - platform: linux-arm64v8
            runner: ubuntu-latest
            license: bsd
            arch: aarch64
            arch-verify: "aarch64"
          - platform: linux-arm64v8
            runner: ubuntu-latest
            license: lgpl
            arch: aarch64
            arch-verify: "aarch64"
          - platform: linux-arm64v8
            runner: ubuntu-latest
            license: gpl
            arch: aarch64
            arch-verify: "aarch64"

          # Linux musl x64 (Docker builds)
          - platform: linuxmusl-x64
            runner: ubuntu-latest
            license: bsd
            arch: x86_64
            arch-verify: "x86-64"
          - platform: linuxmusl-x64
            runner: ubuntu-latest
            license: lgpl
            arch: x86_64
            arch-verify: "x86-64"
          - platform: linuxmusl-x64
            runner: ubuntu-latest
            license: gpl
            arch: x86_64
            arch-verify: "x86-64"

          # Linux musl ARM64 (Docker with QEMU)
          - platform: linuxmusl-arm64v8
            runner: ubuntu-latest
            license: bsd
            arch: aarch64
            arch-verify: "aarch64"
          - platform: linuxmusl-arm64v8
            runner: ubuntu-latest
            license: lgpl
            arch: aarch64
            arch-verify: "aarch64"
          - platform: linuxmusl-arm64v8
            runner: ubuntu-latest
            license: gpl
            arch: aarch64
            arch-verify: "aarch64"

          # Linux ARMv6 (Docker with QEMU - Raspberry Pi)
          - platform: linux-armv6
            runner: ubuntu-latest
            license: bsd
            arch: arm
            arch-verify: "ARM"
          - platform: linux-armv6
            runner: ubuntu-latest
            license: lgpl
            arch: arm
            arch-verify: "ARM"
          - platform: linux-armv6
            runner: ubuntu-latest
            license: gpl
            arch: arm
            arch-verify: "ARM"

          # Linux ppc64le (Docker with QEMU - IBM POWER)
          - platform: linux-ppc64le
            runner: ubuntu-latest
            license: bsd
            arch: ppc64le
            arch-verify: "PowerPC"
          - platform: linux-ppc64le
            runner: ubuntu-latest
            license: lgpl
            arch: ppc64le
            arch-verify: "PowerPC"
          - platform: linux-ppc64le
            runner: ubuntu-latest
            license: gpl
            arch: ppc64le
            arch-verify: "PowerPC"

          # Linux RISC-V 64 (Docker with QEMU)
          - platform: linux-riscv64
            runner: ubuntu-latest
            license: bsd
            arch: riscv64
            arch-verify: "RISC-V"
          - platform: linux-riscv64
            runner: ubuntu-latest
            license: lgpl
            arch: riscv64
            arch-verify: "RISC-V"
          - platform: linux-riscv64
            runner: ubuntu-latest
            license: gpl
            arch: riscv64
            arch-verify: "RISC-V"

          # Linux s390x (Docker with QEMU - IBM Z)
          - platform: linux-s390x
            runner: ubuntu-latest
            license: bsd
            arch: s390x
            arch-verify: "S/390"
          - platform: linux-s390x
            runner: ubuntu-latest
            license: lgpl
            arch: s390x
            arch-verify: "S/390"
          - platform: linux-s390x
            runner: ubuntu-latest
            license: gpl
            arch: s390x
            arch-verify: "S/390"

    # Cancel in-progress builds for same platform/license/ref combination
    # Uses inputs.ref for release builds, github.sha for CI builds
    concurrency:
      group: build-${{ matrix.platform }}-${{ matrix.license }}-${{ inputs.ref || github.sha }}
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.sha }}

      - name: Set up QEMU (Linux cross-arch)
        if: startsWith(matrix.platform, 'linux') && matrix.arch != 'x86_64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.arch }}

      - name: Set up Docker Buildx (Linux)
        if: startsWith(matrix.platform, 'linux')
        uses: docker/setup-buildx-action@v3

      - name: Cache sources
        uses: actions/cache@v4
        with:
          path: build/${{ matrix.platform }}/sources
          key: sources-${{ matrix.platform }}-${{ hashFiles('shared/versions.mk') }}
          restore-keys: |
            sources-${{ matrix.platform }}-

      - name: Build FFmpeg
        run: LICENSE=${{ matrix.license }} ./platforms/${{ matrix.platform }}/build.sh all
        env:
          DEBUG: ${{ runner.debug }}

      - name: Verify binary architecture
        run: |
          FFMPEG_BIN="artifacts/${{ matrix.platform }}-${{ matrix.license }}/bin/ffmpeg"

          if [[ ! -f "$FFMPEG_BIN" ]]; then
            echo "::error::Binary not found: $FFMPEG_BIN"
            exit 1
          fi

          echo "Verifying $FFMPEG_BIN architecture..."
          file "$FFMPEG_BIN"

          if ! file "$FFMPEG_BIN" | grep -qE "${{ matrix.arch-verify }}"; then
            echo "::error::Architecture mismatch! Expected ${{ matrix.arch-verify }}"
            exit 1
          fi

          echo "Architecture verified: ${{ matrix.arch-verify }}"

      - name: Create tarball and checksum
        run: |
          TARBALL="ffmpeg-${{ matrix.platform }}-${{ matrix.license }}.tar.gz"

          tar -czvf "$TARBALL" \
            -C artifacts "${{ matrix.platform }}-${{ matrix.license }}"

          # Verify tarball has reasonable size (>1MB for FFmpeg)
          if [[ "$OSTYPE" == "darwin"* ]]; then
            TARBALL_SIZE=$(stat -f%z "$TARBALL")
          else
            TARBALL_SIZE=$(stat -c%s "$TARBALL")
          fi

          if [[ "$TARBALL_SIZE" -lt 1000000 ]]; then
            echo "::error::Tarball suspiciously small: ${TARBALL_SIZE} bytes"
            exit 1
          fi
          echo "Created $TARBALL (${TARBALL_SIZE} bytes)"

          shasum -a 256 "$TARBALL" > "${TARBALL}.sha256"

      - name: Generate build attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: 'ffmpeg-${{ matrix.platform }}-${{ matrix.license }}.tar.gz'

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${{ matrix.platform }}-${{ matrix.license }}
          path: |
            ffmpeg-${{ matrix.platform }}-${{ matrix.license }}.tar.gz
            ffmpeg-${{ matrix.platform }}-${{ matrix.license }}.tar.gz.sha256
          retention-days: ${{ inputs.retention-days }}
