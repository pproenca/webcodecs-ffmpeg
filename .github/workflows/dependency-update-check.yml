name: Dependency Update Check

# Check for new FFmpeg and codec versions weekly
on:
  schedule:
    - cron: '0 8 * * 1'  # Every Monday at 8 AM UTC
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # For creating PR
  pull-requests: write  # For creating PR

jobs:
  check-updates:
    name: Check for dependency updates
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Check for updates
        id: check
        run: npm run fetch-versions:write

      - name: Create Pull Request
        if: steps.check.outputs.updates_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): Update dependencies\n\n${{ steps.check.outputs.update_summary }}"
          title: "chore(deps): Update FFmpeg and codec dependencies"
          body: |
            ## Dependency Updates Available

            This PR was automatically generated by the dependency update checker.

            ${{ steps.check.outputs.update_summary }}

            ### Verification Steps

            1. Review changelog links for each updated dependency
            2. Check for security advisories or breaking changes
            3. Test builds locally:
               ```bash
               ./build/orchestrator.sh darwin-arm64
               ./tests/run-all-tests.sh
               ```
            4. Run security scan:
               ```bash
               ./security/scan-artifacts.sh
               ```
            5. Verify no regressions in performance benchmarks

            ### Manual Review Required

            - [ ] Review FFmpeg changelog
            - [ ] Review codec changelog (if applicable)
            - [ ] Test critical functionality
            - [ ] Check for API changes
            - [ ] Verify license compatibility
            - [ ] Run full CI build

            **Note:** This is an automated PR. Always review changes carefully before merging.

            See [versions.properties](versions.properties) for updated versions.
          branch: automated/dependency-update-${{ github.run_number }}
          delete-branch: true
          labels: |
            dependencies
            automated

      - name: Comment if no updates
        if: steps.check.outputs.updates_available != 'true'
        run: |
          {
            echo "âœ… No dependency updates available"
            echo ""
            echo "All dependencies are up to date:"
            echo "\`\`\`"
            cat versions.properties | grep "_VERSION="
            echo "\`\`\`"
          } >> "$GITHUB_STEP_SUMMARY"
